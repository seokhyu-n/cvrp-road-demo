# ğŸšš ìë™ë°°ì†¡ ì‹œìŠ¤í…œ (CVRP Road)
## AI ê¸°ë°˜ ìš©ëŸ‰ ì œì•½ ë°°ì†¡ ê²½ë¡œ ìµœì í™”(CVRP) + ì‹¤ì œ ë„ë¡œ ê²½ë¡œ(OSRM) ì›¹ ë°ëª¨

<div align="center">

[![FastAPI](https://img.shields.io/badge/FastAPI-0.110+-009688?logo=fastapi&logoColor=white)](https://fastapi.tiangolo.com/)
[![PyTorch](https://img.shields.io/badge/PyTorch-2.x-EE4C2C?logo=pytorch&logoColor=white)](https://pytorch.org/)
[![Leaflet](https://img.shields.io/badge/Leaflet-Map-199900?logo=leaflet&logoColor=white)](https://leafletjs.com/)
[![Render](https://img.shields.io/badge/Render-Deployed-5B2EFF?logo=render&logoColor=white)](https://render.com/)

**â€œì§€ë„ì—ì„œ ì¥ì†Œë¥¼ ì°ìœ¼ë©´, AIê°€ íšŒì°¨(Trip)ë¥¼ ë‚˜ëˆ  ìµœì  ë°°ì†¡ ê²½ë¡œë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.â€**

**Live Demo:** https://cvrp-road-demo.onrender.com/

</div>

---

## ğŸ“Œ ê°œìš”

**ìë™ë°°ì†¡ ì‹œìŠ¤í…œ (CVRP Road)** ëŠ” ë¬¼ë¥˜ í˜„ì¥ì—ì„œ ìì£¼ ë“±ì¥í•˜ëŠ” **CVRP(Capacitated Vehicle Routing Problem)** ë¥¼ ëŒ€ìƒìœ¼ë¡œ,  
ë”¥ëŸ¬ë‹ ê¸°ë°˜ ê²½ë¡œ ìƒì„± ëª¨ë¸ì´ ê³ ê° ë°©ë¬¸ ìˆœì„œë¥¼ ì˜ˆì¸¡í•˜ê³ , **ìš©ëŸ‰(capacity) ì´ˆê³¼ ì‹œ ìë™ìœ¼ë¡œ íšŒì°¨(Trip)ë¥¼ ë¶„í• **í•˜ë©°,  
ê° íšŒì°¨ì˜ ì´ë™ì€ **OSRM ë„ë¡œ ë¼ìš°íŒ…**ìœ¼ë¡œ ì‹¤ì œ ë„ë¡œ ê±°ë¦¬/ì‹œê°„ê¹Œì§€ ê³„ì‚°í•´ ì‹œê°í™”í•˜ëŠ” ì›¹ ë°ëª¨ì…ë‹ˆë‹¤.

- **CVRP**: ê° ê³ ê°ì˜ ìˆ˜ìš”(demand)ë¥¼ ì‹£ê³  ë°°ì†¡í•  ë•Œ, ì°¨ëŸ‰ ìš©ëŸ‰(capacity)ì„ ë„˜ì§€ ì•Šë„ë¡ ê²½ë¡œë¥¼ êµ¬ì„±í•˜ëŠ” ìµœì í™” ë¬¸ì œ
- ë³¸ í”„ë¡œì íŠ¸ëŠ” â€œëª¨ë¸ ì¶œë ¥ â†’ íšŒì°¨ ë¶„í•  â†’ ë„ë¡œ ê±°ë¦¬/ì‹œê°„ ê³„ì‚° â†’ ì§€ë„ ì‹œê°í™”â€ê¹Œì§€ **ì‹¤ì‚¬ìš© íë¦„ì— ê°€ê¹ê²Œ ì—°ê²°**í–ˆìŠµë‹ˆë‹¤.

---

## ğŸ¯ ëª©í‘œ

- ì‚¬ìš©ìê°€ **ì§€ë„ì—ì„œ ë°°ì†¡ ì§€ì (ì°½ê³  + ê³ ê°)** ì„ ì‰½ê²Œ êµ¬ì„±
- ê³ ê°ë§ˆë‹¤ **ë¬¼ë¥˜ëŸ‰(demand)** ì„ ì„¤ì •
- AIê°€ **ë°©ë¬¸ ìˆœì„œ + íšŒì°¨ ë¶„í• (trip split)** ì„ ìë™ ìƒì„±
- OSRMìœ¼ë¡œ ê° íšŒì°¨ì˜ **ë„ë¡œ ê±°ë¦¬(km) / ì‹œê°„(ë¶„)** ì„ ê³„ì‚°
- ê²°ê³¼ë¥¼ í‘œ/ì§€ë„(Polyline)ë¡œ ì œê³µí•˜ì—¬ **ì„¤ëª… ê°€ëŠ¥í•œ ë°ëª¨**ë¡œ ì œì‹œ

---

## ğŸ‘¥ íƒ€ê²Ÿ

- **ì›¹ ì„œë¹„ìŠ¤(Web Demo)** í˜•íƒœ  
  - ë°œí‘œ/ë°ëª¨ ëª©ì : ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥  
  - ë¬¼ë¥˜ ìµœì í™”/AI ê²½ë¡œ ìƒì„± ì—°êµ¬ ê²°ê³¼ë¥¼ ì‰½ê²Œ ì‹œì—° ê°€ëŠ¥

---

## âœ¨ í•µì‹¬ ê¸°ëŠ¥

### 1) ì¥ì†Œ ê²€ìƒ‰ (Kakao Local API)
- í‚¤ì›Œë“œ ê¸°ë°˜ ì¥ì†Œ ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ì œê³µ
- ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ â†’ ì§€ë„ì— ë§ˆì»¤ ì¶”ê°€
- (Fallback) í‚¤ê°€ ì—†ìœ¼ë©´ Nominatim(OpenStreetMap)ìœ¼ë¡œ ê²€ìƒ‰ ê°€ëŠ¥

### 2) ë°°ì†¡ ì§€ì  ê´€ë¦¬
- ì²« ë²ˆì§¸ ì§€ì ì€ **ì°½ê³ (Depot)**
- ì´í›„ ì§€ì ì€ **ê³ ê°(Customer)**
- ê³ ê° ë§ˆì»¤ í´ë¦­ ì‹œ **demand ìˆ˜ì •**
- ê³ ê° ì‚­ì œ ì‹œ ì¸ë±ìŠ¤ ì¬ì •ë ¬ + UI ë™ê¸°í™”

### 3) AI ê¸°ë°˜ ê²½ë¡œ ìƒì„± + íšŒì°¨ ë¶„í• 
- ëª¨ë¸ì´ ì˜ˆì¸¡í•œ ê²½ë¡œì—ì„œ **ê³ ê° ë°©ë¬¸ ìˆœì„œë§Œ ì¶”ì¶œ**
- **capacity ê¸°ì¤€ìœ¼ë¡œë§Œ** depot ë³µê·€ë¥¼ ì‚½ì…í•˜ì—¬ íšŒì°¨ë¥¼ êµ¬ì„± (ë¶ˆí•„ìš”í•œ depot ë°˜ë³µ ì œê±°)

### 4) ë„ë¡œ ê±°ë¦¬/ì‹œê°„ ê³„ì‚°(OSRM)
- ê° tripë³„ ì¢Œí‘œë¥¼ OSRMì— ì „ë‹¬
- polylineì„ ì§€ë„ì— í‘œì‹œ + í‘œì— **km/min** ìš”ì•½

---

## ğŸ§  AI ëª¨ë¸(ë”¥ëŸ¬ë‹) ê°œìš”

ë³¸ í”„ë¡œì íŠ¸ ëª¨ë¸ì€ **Transformer Encoder + Pointer-style Decoder** êµ¬ì¡°ì…ë‹ˆë‹¤.

### ì…ë ¥(ë…¸ë“œ íŠ¹ì§•)
ê° ë…¸ë“œëŠ” ë‹¤ìŒ 3ê°œ featureë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.
- `(x, y)` : ì¢Œí‘œ
- `demand_ratio = demand / capacity` : ìš©ëŸ‰ ëŒ€ë¹„ ìˆ˜ìš” ë¹„ìœ¨

### Encoder (Transformer)
- ëª¨ë“  ë…¸ë“œ(Depot + Customers)ë¥¼ ì„ë² ë”© í›„ Transformer Encoderë¡œ ì¸ì½”ë”©
- ê²°ê³¼: ê° ë…¸ë“œì˜ ë¬¸ë§¥ ì„ë² ë”© `h (B, N, E)` + ì „ì²´ ìš”ì•½ `global_ctx`

### Decoder (Pointer)
- í˜„ì¬ ìœ„ì¹˜ ë…¸ë“œ ì„ë² ë”© + global_ctx + remaining_capacity ì •ë³´ë¥¼ ê²°í•©í•´ query ìƒì„±
- ëª¨ë“  ë…¸ë“œì— ëŒ€í•œ pointer logitsë¥¼ ê³„ì‚°í•˜ì—¬ ë‹¤ìŒ ë°©ë¬¸ ë…¸ë“œë¥¼ ì„ íƒ
- **Masking**ìœ¼ë¡œ
  - ì´ë¯¸ ë°©ë¬¸í•œ ê³ ê°
  - ë‚¨ì€ ìš©ëŸ‰ë³´ë‹¤ demand_ratioê°€ í° ê³ ê°  
  ì„ ì„ íƒí•˜ì§€ ëª»í•˜ë„ë¡ ì œí•œ

### ë””ì½”ë”© ë°©ì‹
- `greedy` : í•­ìƒ ìµœê³  í™•ë¥  ë…¸ë“œ ì„ íƒ (ë°ëª¨ì—ì„œ ì‚¬ìš©)
- `sampling` : í™•ë¥ ì ìœ¼ë¡œ ìƒ˜í”Œë§ (RL/íƒìƒ‰ ì„±ëŠ¥ í–¥ìƒ ì‹¤í—˜ìš©)

---

## ğŸ” â€œíšŒì°¨(Trip) ë¶„í• â€ ë°©ì‹

í˜„ì‹¤ ë°°ì†¡ì—ì„œëŠ” **ìš©ëŸ‰(capacity)** ì´ í•µì‹¬ ì œì•½ì…ë‹ˆë‹¤.  
ë”°ë¼ì„œ ëª¨ë¸ ì¶œë ¥ì´ depot(0)ì„ ë¶ˆí•„ìš”í•˜ê²Œ ë§ì´ ì°ëŠ” ê²½ìš°ê°€ ìˆì–´ë„, ë³¸ í”„ë¡œì íŠ¸ëŠ” ë‹¤ìŒ ì •ì±…ìœ¼ë¡œ ì•ˆì •í™”í–ˆìŠµë‹ˆë‹¤.

### âœ… Capacity-only Trip Split (í•µì‹¬ ì•„ì´ë””ì–´)
1. ëª¨ë¸ pathì—ì„œ **ê³ ê° ë°©ë¬¸ ìˆœì„œë§Œ ì¶”ì¶œ**
   - `0(depot)` ì œê±°
   - ì¤‘ë³µ ê³ ê° ì œê±°
   - ëˆ„ë½ ê³ ê°ì€ ë’¤ì— ì•ˆì „í•˜ê²Œ ì¶”ê°€
2. ê³ ê°ë“¤ì„ ìˆœì„œëŒ€ë¡œ ë‹´ë˜,
   - `load + demand > capacity` ê°€ ë˜ëŠ” ìˆœê°„ì—ë§Œ depot ë³µê·€(íšŒì°¨ ì¢…ë£Œ)
3. ê²°ê³¼ì ìœ¼ë¡œ â€œí•„ìš”í•  ë•Œë§Œ depot ë³µê·€â€í•˜ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ tripì´ ìƒì„±ë©ë‹ˆë‹¤.

> ë°œí‘œ í¬ì¸íŠ¸: **â€œëª¨ë¸ì´ 0ì„ ë‚¨ë°œí•´ë„, ì‹¤ì œ ìš´ì˜ ê·œì¹™(ìš©ëŸ‰) ê¸°ë°˜ìœ¼ë¡œ í›„ì²˜ë¦¬í•˜ì—¬ ì•ˆì •ì  ë°ëª¨ë¥¼ êµ¬í˜„â€**

---

## ğŸ“ˆ í•™ìŠµ/í‰ê°€ (Colab)

Colabì—ì„œ ë‹¤ìŒ íë¦„ìœ¼ë¡œ ì„±ëŠ¥ì„ ì ê²€í–ˆìŠµë‹ˆë‹¤.

- Baseline: **Nearest Neighbor + Capacity constraint**
- Model: Transformer+Pointer ëª¨ë¸ ê²½ë¡œ ìƒì„± â†’ **capacity-only repair í›„ í‰ê°€**
- í‰ê°€ ì§€í‘œ: ìœ í´ë¦¬ë“œ ê±°ë¦¬ ê¸°ë°˜ ë¹„êµ(ì •ê·œí™” ì¢Œí‘œ)

ê·¸ë˜í”„(ì˜ˆì‹œ):
- improvement histogram (ê°œì„  ë¶„í¬)
- sorted distance plot (ì¸ìŠ¤í„´ìŠ¤ë³„ ê±°ë¦¬ ë¹„êµ)
- worst-case ë””ë²„ê·¸ ì¶œë ¥(ë¶ˆí•„ìš” depot ë°©ë¬¸ ì œê±° í™•ì¸)

> ì •í™•í•œ ìˆ˜ì¹˜(í‰ê·  ê°œì„ ìœ¨ ë“±)ëŠ” ì‹¤í—˜ ë¡œê·¸ì— ë§ì¶° READMEì— ì¶”ê°€í•˜ë©´ ë” ì¢‹ìŠµë‹ˆë‹¤.

---

## ğŸ—ºï¸ ì‹œìŠ¤í…œ êµ¬ì„±(ì•„í‚¤í…ì²˜)

[Web UI: Leaflet/JS]
â”œâ”€ ì¥ì†Œ ê²€ìƒ‰ ìš”ì²­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [FastAPI /geocode] â”€â–º Kakao Local API
â”œâ”€ AI Solve ìš”ì²­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [FastAPI /solve] â”€â–º CVRPModel (PyTorch)
â””â”€ ë„ë¡œ ë¼ìš°íŒ… ìš”ì²­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [FastAPI /route] â”€â–º OSRM (public)
â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê²°ê³¼(trips, km/min, polyline)


---

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

- **Backend**: FastAPI, Python, requests
- **AI**: PyTorch (Transformer Encoder + Pointer Decoder)
- **Map UI**: Leaflet
- **Geocoding**: Kakao Local API (í‚¤ì›Œë“œ/ì£¼ì†Œ ê²€ìƒ‰), fallback Nominatim
- **Routing**: OSRM public API
- **Deploy**: Render

---

## ğŸ”‘ í™˜ê²½ ë³€ìˆ˜ (ì¤‘ìš”)

### Render Environment Variables
- `KAKAO_REST_API_KEY` : Kakao Local REST API Key
- `CVRP_MODEL` : ëª¨ë¸ ì²´í¬í¬ì¸íŠ¸ ê²½ë¡œ (ì„ íƒ)  
  - ì˜ˆ: `checkpoints/best.pt`

âœ… **ì£¼ì˜**: API í‚¤ëŠ” ì½”ë“œì— í•˜ë“œì½”ë”©í•˜ì§€ ì•Šê³  **í™˜ê²½ë³€ìˆ˜ë¡œë§Œ** ê´€ë¦¬í•©ë‹ˆë‹¤.

---

## ğŸ“¡ API ì—”ë“œí¬ì¸íŠ¸

- `GET /` : ì›¹ UI(index.html)
- `GET /health` : ì„œë²„ ìƒíƒœ í™•ì¸(ë°°í¬ ê¹¨ìš°ê¸° ìš©)
- `GET /geocode?q=...&limit=30` : ì¥ì†Œ ê²€ìƒ‰
- `POST /solve` : AI ê²½ë¡œ ìƒì„± + capacity-only trip split
- `POST /route` : OSRM ë„ë¡œ ê²½ë¡œ(polyline) + ê±°ë¦¬/ì‹œê°„

---

## ğŸ§ª ë¡œì»¬ ì‹¤í–‰ ë°©ë²•

### 1) ì˜ì¡´ì„± ì„¤ì¹˜
```bash
pip install -r requirements.txt


## í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# mac/linux
export KAKAO_REST_API_KEY="YOUR_KEY"

# windows powershell
setx KAKAO_REST_API_KEY "YOUR_KEY"

##ì‹¤í–‰
uvicorn api.app:app --host 0.0.0.0 --port 8000 --reload
ì ‘ì†: http://localhost:8000

## ì ‘ì†: http://localhost:8000)
cvrp-road-demo/
â”œâ”€ api/
â”‚  â””â”€ app.py                 # FastAPI ì„œë²„ (geocode/solve/route)
â”œâ”€ cvrp/
â”‚  â”œâ”€ model.py               # CVRPModel (Transformer + Pointer)
â”‚  â””â”€ data.py                # route_length ë“± ìœ í‹¸
â”œâ”€ web/
â”‚  â””â”€ index.html             # Leaflet UI
â”œâ”€ checkpoints/
â”‚  â””â”€ best.pt                
â””â”€ README.md

